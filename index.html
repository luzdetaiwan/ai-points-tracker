<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI é»æ•¸å…±ç”¨è¡¨</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script type="importmap">
  {
    "imports": {
      "react": "https://esm.sh/react@18.2.0",
      "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
      "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
      "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js",
      "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js"
    }
  }
  </script>
</head>
<body class="bg-slate-50 min-h-screen">
  <div id="root"></div>

  <script type="text/babel" data-type="module">
    import React, { useState, useEffect, useMemo, useRef } from 'react';
    import { createRoot } from 'react-dom/client';
    import { initializeApp } from 'firebase/app';
    import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
    import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, serverTimestamp } from 'firebase/firestore';

    // ==========================================
    // â–¼â–¼â–¼ è«‹åœ¨ä¸‹æ–¹è²¼ä¸Šæ‚¨çš„ Firebase è¨­å®š â–¼â–¼â–¼
    // ==========================================
    
    const firebaseConfig = {
      apiKey: "AIzaSyBnYO2CsM-Len1qq2Ey1ccWl0I8dqJ3tlo",
  authDomain: "gemini-ai-points-tracker.firebaseapp.com",
  projectId: "gemini-ai-points-tracker",
  storageBucket: "gemini-ai-points-tracker.firebasestorage.app",
  messagingSenderId: "473244235534",
  appId: "1:473244235534:web:ae561598b2328bfd4e895f",
  measurementId: "G-ESBL56N8MP"
    };

    // â–²â–²â–² è¨­å®šçµæŸ â–²â–²â–²
    // ==========================================

    // â–¼â–¼â–¼ è¨­å®šæ‚¨çš„å®¶æ—å¯†ç¢¼ â–¼â–¼â–¼
    const FAMILY_PASSWORD = "6661225"; 
    // â–²â–²â–² æ‚¨å¯ä»¥æ”¹æˆè‡ªå·±å–œæ­¡çš„æ•¸å­— â–²â–²â–²

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const appId = "ai-points-tracker";
    const TOTAL_POOL = 1000;
    const STANDARD_QUOTA = 166;

    function App() {
      // --- å¯†ç¢¼é–å®šç‹€æ…‹ ---
      const [isLoggedIn, setIsLoggedIn] = useState(false);
      const [inputPwd, setInputPwd] = useState("");
      const [pwdError, setPwdError] = useState("");

      // --- ä¸»ç¨‹å¼ç‹€æ…‹ ---
      const [user, setUser] = useState(null);
      const [usersData, setUsersData] = useState([]);
      const [loading, setLoading] = useState(true);
      const isSubmittingRef = useRef(false);
      const [isSubmittingVisual, setIsSubmittingVisual] = useState(false);
      const [isEditing, setIsEditing] = useState(false);
      const [editId, setEditId] = useState(null);
      const [formData, setFormData] = useState({ name: '', points: 0, note: '', isDonated: false });
      const [error, setError] = useState('');

      // æª¢æŸ¥æœ‰æ²’æœ‰å­˜éå¯†ç¢¼ (è®“å®¶äººä¸ç”¨æ¯æ¬¡éƒ½è¼¸å…¥)
      useEffect(() => {
        const savedPwd = localStorage.getItem("family_pwd");
        if (savedPwd === FAMILY_PASSWORD) {
          setIsLoggedIn(true);
        }
      }, []);

      // æ¯æœˆ 25 è™Ÿè‡ªå‹•åˆ‡æ›é‚è¼¯
      const currentMonthKey = useMemo(() => {
        const now = new Date();
        let year = now.getFullYear();
        let month = now.getMonth() + 1;
        const day = now.getDate();
        if (day >= 25) {
          month += 1;
          if (month > 12) { month = 1; year += 1; }
        }
        return `${year}-${String(month).padStart(2, '0')}`;
      }, []);

      // åˆå§‹åŒ– Firebase Auth (åªåœ¨è§£é–å¾ŒåŸ·è¡Œ)
      useEffect(() => {
        if (!isLoggedIn) return;
        signInAnonymously(auth).catch((e) => console.error(e));
        return onAuthStateChanged(auth, setUser);
      }, [isLoggedIn]);

      // è®€å–è³‡æ–™ (åªåœ¨è§£é–å¾ŒåŸ·è¡Œ)
      useEffect(() => {
        if (!user || !isLoggedIn) return;
        const q = collection(db, 'artifacts', appId, 'public', 'data', 'ai_points_users_v2');
        const unsubscribe = onSnapshot(q, (snapshot) => {
          const allData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          const currentMonthData = allData.filter(item => item.month === currentMonthKey);
          currentMonthData.sort((a, b) => (b.points || 0) - (a.points || 0));
          setUsersData(currentMonthData);
          setLoading(false);
        });
        return () => unsubscribe();
      }, [user, currentMonthKey, isLoggedIn]);

      const handleLogin = (e) => {
        e.preventDefault();
        if (inputPwd === FAMILY_PASSWORD) {
          setIsLoggedIn(true);
          localStorage.setItem("family_pwd", inputPwd); // è¨˜ä½å¯†ç¢¼
          setPwdError("");
        } else {
          setPwdError("å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹è©¢å•å®¶äºº");
        }
      };

      // === å¦‚æœé‚„æ²’è§£é–ï¼Œé¡¯ç¤ºé–å®šç•«é¢ ===
      if (!isLoggedIn) {
        return (
          <div className="min-h-screen flex items-center justify-center bg-slate-100 p-4">
            <div className="bg-white p-8 rounded-2xl shadow-lg max-w-sm w-full text-center">
              <div className="text-4xl mb-4">ğŸ”’</div>
              <h1 className="text-xl font-bold text-slate-800 mb-2">AI é»æ•¸å…±ç”¨è¡¨</h1>
              <p className="text-slate-500 mb-6 text-sm">è«‹è¼¸å…¥å®¶æ—é€šè¡Œç¢¼</p>
              <form onSubmit={handleLogin} className="space-y-4">
                <input 
                  type="text" // æ”¹æˆ text æ¯”è¼ƒå¥½æ‰“æ•¸å­—ï¼Œå¦‚æœè¦éš±è—å¯æ”¹ password
                  value={inputPwd}
                  onChange={(e) => setInputPwd(e.target.value)}
                  className="w-full text-center text-2xl tracking-widest p-3 border border-slate-300 rounded-xl focus:outline-none focus:border-indigo-500 font-mono"
                  placeholder="Passcode"
                  inputMode="numeric"
                />
                {pwdError && <div className="text-red-500 text-sm">{pwdError}</div>}
                <button type="submit" className="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold hover:bg-indigo-700 transition-colors">
                  è§£é–é€²å…¥
                </button>
              </form>
            </div>
          </div>
        );
      }

      // === ä»¥ä¸‹æ˜¯ä¸»ç¨‹å¼ ===
      const totalUsed = usersData.reduce((acc, curr) => acc + (curr.isDonated ? 0 : Number(curr.points)), 0);
      const poolPercentage = Math.min(100, Math.max(0, (totalUsed / TOTAL_POOL) * 100));
      const timeoutPromise = (ms) => new Promise((_, reject) => setTimeout(() => reject(new Error("ç¶²è·¯å›æ‡‰éæ…¢ï¼Œè«‹é‡è©¦")), ms));

      const handleSubmit = async (e) => {
        e.preventDefault();
        if (isSubmittingRef.current) return;
        isSubmittingRef.current = true;
        setIsSubmittingVisual(true);

        if (!user) {
          alert("æ­£åœ¨é€£ç·šä¸­ï¼Œè«‹ç¨å€™å†è©¦...");
          isSubmittingRef.current = false;
          setIsSubmittingVisual(false);
          return;
        }
        if (!formData.name.trim()) {
           setError("è«‹è¼¸å…¥å§“å");
           isSubmittingRef.current = false;
           setIsSubmittingVisual(false);
           return;
        }

        setError('');

        try {
          const payload = {
            name: formData.name,
            points: formData.isDonated ? 0 : Number(formData.points),
            note: formData.note,
            isDonated: formData.isDonated,
            month: currentMonthKey,
            updatedAt: serverTimestamp(),
            updatedBy: user.uid
          };

          const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'ai_points_users_v2');
          
          if (isEditing && editId) {
            await Promise.race([ updateDoc(doc(colRef, editId), payload), timeoutPromise(10000) ]);
          } else {
            await Promise.race([ addDoc(colRef, payload), timeoutPromise(10000) ]);
          }
          
          resetForm();
        } catch (err) { 
          console.error(err);
          alert("å­˜æª”å¤±æ•—: " + err.message); 
        } finally {
          isSubmittingRef.current = false;
          setIsSubmittingVisual(false);
        }
      };

      const handleDelete = async (id) => {
        if (!confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†è³‡æ–™å—ï¼Ÿ")) return;
        try {
          await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'ai_points_users_v2', id));
        } catch(e) { alert("åˆªé™¤å¤±æ•—"); }
      };

      const handleInputChange = (e) => {
        const { name, value, type, checked } = e.target;
        setFormData(prev => ({ ...prev, [name]: type === 'checkbox' ? checked : value }));
        if (name === 'isDonated' && checked) setFormData(prev => ({ ...prev, points: 0 }));
      };

      const startEdit = (item) => {
        setIsEditing(true);
        setEditId(item.id);
        setFormData({ name: item.name, points: item.points, note: item.note || '', isDonated: item.isDonated || false });
        window.scrollTo({ top: 0, behavior: 'smooth' });
      };

      const resetForm = () => {
        setIsEditing(false);
        setEditId(null);
        setFormData({ name: '', points: 0, note: '', isDonated: false });
        setError('');
      };

      const renderStatus = (points, isDonated) => {
        if (isDonated) return { label: 'â¤ï¸ å…¨é¡æè´ˆ', color: 'text-rose-500 bg-rose-50' };
        if (points > STANDARD_QUOTA) return { label: `ğŸ“ˆ è¶…é¡ ${points - STANDARD_QUOTA}`, color: 'text-amber-600 bg-amber-50' };
        if (points < STANDARD_QUOTA) return { label: `ğŸ“‰ çœä¸‹ ${STANDARD_QUOTA - points}`, color: 'text-emerald-600 bg-emerald-50' };
        return { label: 'âœ… æ¨™æº–é¡åº¦', color: 'text-slate-500 bg-slate-50' };
      };

      return (
        <div className="max-w-3xl mx-auto p-4 pb-12 font-sans">
          
          {/* å…¬å‘Šèªªæ˜å¡ç‰‡ */}
          <div className="bg-gradient-to-r from-indigo-50 to-white border border-indigo-100 p-5 rounded-xl shadow-sm mb-6">
            <h2 className="font-bold text-indigo-800 text-lg mb-3 flex items-center gap-2">
               å“ˆå›‰ ä¸€èµ·Share Gemini Proçš„å®¶äººå€‘â¤ï¸
            </h2>
            <div className="text-slate-600 text-sm space-y-2 leading-relaxed">
              <p>æˆ‘å€‘ä½¿ç”¨çš„ Pro æ–¹æ¡ˆï¼Œæ¯æœˆæœƒè´ˆé€ <strong className="text-indigo-600">1000é»</strong> çš„ AI é»æ•¸ã€‚</p>
              <p>é»æ•¸å¯ç”¨æ–¼ flow è£½ä½œå½±ç‰‡ï¼Œæˆ–æ˜¯ whisk åˆæˆç…§ç‰‡ã€‚</p>
              <div className="my-3 border-t border-indigo-100"></div>
              <p>æˆ‘å€‘çš„è¨ˆç®—é€±æœŸæ˜¯æ¯å€‹æœˆçš„ <span className="font-bold text-rose-500 bg-rose-50 px-1 rounded">25è™Ÿ</span>ã€‚</p>
              <p>(25è™Ÿå‰æœªä½¿ç”¨çš„é»æ•¸æœƒæ­¸é›¶ï¼Œ25è™Ÿèµ·é‡æ–°ä»¥1000é»è¨ˆç®—)</p>
              <p>ç‚ºæ–¹ä¾¿æœ‰æ•ˆä½¿ç”¨é€™1000é»ï¼Œè«‹å¤§å®¶ç™»è¨˜å·²ä½¿ç”¨çš„é»æ•¸ã€‚</p>
              <p>æˆ–æ˜¯ <span className="font-bold text-slate-700">ä¸ä½¿ç”¨çš„è©±ï¼Œä¹Ÿå¯ä»¥æå‡ºçµ¦å…¶ä»–äººå…±ç”¨</span>ã€‚</p>
              <p>æ¯äººå¯ä»¥ä½¿ç”¨ <span className="font-bold text-slate-700">166é»/æœˆ</span>ã€‚</p>
              <p className="text-xs text-slate-400 mt-2 flex items-center gap-1">
                <span>â„¹ï¸</span> ç™»è¨˜ä¹‹å¾Œï¼Œè‹¥è¦æ›´æ–°ä½¿ç”¨çš„é»æ•¸ï¼ŒæŒ‰ âœï¸ ä¿®æ­£å³å¯â˜ºï¸
              </p>
            </div>
          </div>

          <div className="bg-white rounded-xl p-4 shadow-sm border border-slate-200 mb-6 sticky top-2 z-10 border-l-4 border-indigo-500">
            <div className="flex justify-between items-center mb-3">
              <h1 className="text-xl font-bold text-slate-800">âš¡ AI é»æ•¸èª¿ç¯€æ± </h1>
              <span className="bg-slate-100 px-3 py-1 rounded-full text-sm font-bold text-slate-600">{currentMonthKey} æœŸ</span>
            </div>
            <div className="w-full bg-slate-200 h-4 rounded-full overflow-hidden mb-2">
               <div className={`h-full transition-all duration-500 ${poolPercentage > 95 ? 'bg-red-500' : poolPercentage > 80 ? 'bg-amber-500' : 'bg-indigo-500'}`} style={{width: `${poolPercentage}%`}}></div>
            </div>
            <div className="flex justify-between text-xs text-slate-500 font-mono">
               <span>å·²ç”¨: {totalUsed}</span>
               <span>å‰©é¤˜: {TOTAL_POOL - totalUsed}</span>
            </div>
          </div>

          <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-5 mb-8">
            <h2 className="text-lg font-bold mb-4 text-slate-700">{isEditing ? 'âœï¸ ä¿®æ­£' : 'â• ç™»è¨˜'}</h2>
            <form onSubmit={handleSubmit} className="space-y-4">
              <div className="grid grid-cols-2 gap-4">
                <div>
                   <label className="block text-sm font-bold text-slate-600 mb-1">å§“å</label>
                   <input className="w-full p-2 border border-slate-300 rounded focus:outline-none focus:border-indigo-500" type="text" name="name" value={formData.name} onChange={handleInputChange} disabled={isSubmittingVisual} />
                </div>
                <div>
                   <label className="block text-sm font-bold text-slate-600 mb-1">ä½¿ç”¨é‡</label>
                   <input className={`w-full p-2 border rounded focus:outline-none ${formData.isDonated ? 'bg-slate-100' : 'border-slate-300'}`} type="number" name="points" value={formData.points} onChange={handleInputChange} disabled={formData.isDonated || isSubmittingVisual} />
                </div>
              </div>
              <input className="w-full p-2 border border-slate-300 rounded" type="text" name="note" placeholder="å‚™è¨»" value={formData.note} onChange={handleInputChange} disabled={isSubmittingVisual} />
              
              <label className="flex items-center gap-2 cursor-pointer">
                <input type="checkbox" name="isDonated" checked={formData.isDonated} onChange={handleInputChange} className="w-4 h-4" disabled={isSubmittingVisual} />
                <span className="text-sm text-slate-600">æˆ‘ä¸éœ€è¦ï¼Œå…¨é¡é‡‹å‡º â¤ï¸</span>
              </label>

              {error && <div className="text-red-600 bg-red-50 p-2 rounded text-sm">âš ï¸ {error}</div>}

              <div className="flex gap-2">
                <button 
                  type="submit" 
                  disabled={isSubmittingVisual}
                  className={`flex-1 py-3 rounded text-white font-bold transition-all
                    ${isSubmittingVisual ? 'bg-slate-400 cursor-not-allowed scale-95' : (isEditing ? 'bg-amber-500 shadow-amber-200 shadow-md' : 'bg-slate-800 shadow-slate-300 shadow-md hover:bg-slate-900')}
                  `}
                >
                  {isSubmittingVisual ? 'è™•ç†ä¸­ (è«‹ç¨å€™)...' : (isEditing ? 'å„²å­˜è®Šæ›´' : 'é€å‡ºç™»è¨˜')}
                </button>
                {isEditing && !isSubmittingVisual && <button type="button" onClick={resetForm} className="px-4 bg-slate-200 rounded text-slate-600">å–æ¶ˆ</button>}
              </div>
            </form>
          </div>

          <div className="space-y-3">
             {loading ? <div className="text-center text-slate-400">è¼‰å…¥ä¸­...</div> : 
              usersData.map(item => {
                const status = renderStatus(item.points, item.isDonated);
                return (
                  <div key={item.id} className="bg-white p-4 rounded-xl border border-slate-200 flex justify-between items-center shadow-sm">
                    <div>
                      <div className="flex items-center gap-2 mb-1">
                        <span className="font-bold text-slate-800 text-lg">{item.name}</span>
                        <span className={`text-xs px-2 py-0.5 rounded ${status.color}`}>{status.label}</span>
                      </div>
                      <div className="text-sm text-slate-500">{item.note}</div>
                    </div>
                    <div className="text-right">
                       <div className="text-xl font-mono font-bold text-slate-700">{item.isDonated ? 0 : item.points}</div>
                       <div className="mt-1 space-x-2">
                         <button onClick={() => startEdit(item)} className="text-slate-400 hover:text-amber-500" disabled={isSubmittingVisual}>âœï¸</button>
                         <button onClick={() => handleDelete(item.id)} className="text-slate-400 hover:text-red-500" disabled={isSubmittingVisual}>ğŸ—‘ï¸</button>
                       </div>
                    </div>
                  </div>
                )
              })}
          </div>
        </div>
      );
    }
    const root = createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>





